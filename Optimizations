-- PS99 OP Optimizer (Final Edition by gpt bhaiya)

local plr = game.Players.LocalPlayer
local Lighting = game:GetService("Lighting")
local StarterGui = game:GetService("StarterGui")
local PlayerGui = plr:WaitForChild("PlayerGui")

-- üìâ FPS Cap (if available)
pcall(function()
	if setfpscap then setfpscap(30) end
end)

-- üñºÔ∏è Lower Quality Settings
pcall(function()
	settings().Rendering.QualityLevel = Enum.QualityLevel.Level01
	settings().Rendering.TextureQuality = Enum.TextureQuality.Low
end)

-- ‚ö° Combine Workspace Descendant Loop
local destroyClasses = {
	Decal = true, Texture = true,
	Accessory = true, Hat = true, Shirt = true, Pants = true, FaceInstance = true,
	ParticleEmitter = true, Trail = true, Beam = true, Smoke = true, Fire = true,
	Explosion = true, Sparkles = true, Highlight = true, SelectionBox = true,
	PointLight = true, SpotLight = true, SurfaceLight = true,
	BillboardGui = true, SurfaceGui = true,
}
local all = workspace:GetDescendants()
for _, v in ipairs(all) do
	local class = v.ClassName

	if destroyClasses[class] then
		pcall(function() v:Destroy() end)

	elseif v:IsA("Sound") then
		pcall(function() v.Volume = 0; v:Stop() end)

	elseif (v:IsA("BasePart") or v:IsA("MeshPart")) and not v:IsDescendantOf(plr.Character) then
		pcall(function()
			v.Transparency = 1
			for _, h in ipairs(v:GetChildren()) do if h:IsA("Highlight") then h:Destroy() end end
			local hl = Instance.new("Highlight")
			hl.Adornee = v
			hl.FillTransparency = 1
			hl.OutlineTransparency = 0
			hl.OutlineColor = Color3.new(1, 1, 1)
			hl.DepthMode = Enum.HighlightDepthMode.AlwaysOnTop
			hl.Parent = v
		end)

	elseif v:IsA("ParticleEmitter") then
		pcall(function() v.Enabled = false; v.Rate = 0; v.Lifetime = NumberRange.new(0); v.Speed = NumberRange.new(0) end)

	elseif v:IsA("Explosion") then
		pcall(function() v.BlastRadius = 0; v.BlastPressure = 0 end)

	elseif v:IsA("Humanoid") and not v:IsDescendantOf(plr.Character) then
		pcall(function() v:Destroy() end)
	end
end

-- üîá CoreGui Sound Kill
for _, v in ipairs(game:GetService("CoreGui"):GetDescendants()) do
	if v:IsA("Sound") then pcall(function() v.Volume = 0; v:Stop() end) end
end

-- üé® Lighting Cleanup
for _, v in ipairs(Lighting:GetChildren()) do
	if v:IsA("Sky") or v:IsA("BlurEffect") or v:IsA("ColorCorrectionEffect")
	or v:IsA("SunRaysEffect") or v:IsA("BloomEffect") or v:IsA("DepthOfFieldEffect") then
		pcall(function() v:Destroy() end)
	end
end
Lighting.ChildAdded:Connect(function(child)
	if child:IsA("Sky") then pcall(function() child:Destroy() end) end
end)
Lighting.Ambient = Color3.new(0, 0, 0)
Lighting.OutdoorAmbient = Color3.new(0, 0, 0)
Lighting.Brightness = 0
pcall(function() Lighting.GlobalShadows = false end)

-- üåä Terrain Kill
local Terrain = workspace:FindFirstChildOfClass("Terrain")
if Terrain then
	pcall(function()
		Terrain:Clear()
		Terrain.WaterTransparency = 1
		Terrain.WaterWaveSize = 0
		Terrain.WaterWaveSpeed = 0
		Terrain.WaterReflectance = 0
		Terrain.WaterColor = Color3.new(0, 0, 0)
	end)
end

-- üßπ Remove Specific Folders
for _, name in ipairs({"Decorations", "Backgrounds", "Trees"}) do
	local f = workspace:FindFirstChild(name)
	if f then pcall(function() f:Destroy() end) end
end

-- üéÆ GUI Cleanup (fixed)
local guiToKeep = { ["FullBlackScreenWithToggle"] = true }

-- üßº Clean CoreGui safely
for _, v in ipairs(game:GetService("CoreGui"):GetDescendants()) do
	if v:IsA("GuiObject") then
		local parentGui = v:FindFirstAncestorOfClass("ScreenGui")
		local isSafe = parentGui and (parentGui:GetAttribute("Safe") or guiToKeep[parentGui.Name])
		if not isSafe then
			pcall(function() v.Visible = false end)
		end
	end
end

-- üßº Clean PlayerGui safely
local PlayerGui = game:GetService("Players").LocalPlayer:WaitForChild("PlayerGui")
for _, v in ipairs(PlayerGui:GetDescendants()) do
	if v:IsA("GuiObject") then
		local parentGui = v:FindFirstAncestorOfClass("ScreenGui")
		local isSafe = parentGui and (parentGui:GetAttribute("Safe") or guiToKeep[parentGui.Name])
		if not isSafe then
			pcall(function() v.Visible = false end)
		end
	end
end

-- üìõ Remove popup GUIs
for _, gui in ipairs(PlayerGui:GetChildren()) do
	local name = gui.Name:lower()
	for _, kw in ipairs({"popup", "notif", "alert", "msg", "dialog", "ad"}) do
		if name:find(kw) then
			pcall(function() gui:Destroy() end)
			break
		end
	end
end

-- üì≤ Disable all CoreGui types except Backpack
local StarterGui = game:GetService("StarterGui")
for _, t in ipairs(Enum.CoreGuiType:GetEnumItems()) do
	if t ~= Enum.CoreGuiType.Backpack then
		pcall(function() StarterGui:SetCoreGuiEnabled(t, false) end)
	end
end

-- üêæ Kill Animations in Pets + Character
for _, source in ipairs({plr.Character, workspace:FindFirstChild("Pets")}) do
	if source then
		for _, v in ipairs(source:GetDescendants()) do
			if v:IsA("Animator") or v:IsA("Animation") then
				pcall(function() v:Destroy() end)
			end
		end
	end
end

-- üßä 1. Freeze Unused Joints & Animations
local function safelyFreezeJointsAndAnimations()
	local char = plr.Character or plr.CharacterAdded:Wait()
	local pets = workspace:FindFirstChild("Pets")
	for _, v in ipairs(workspace:GetDescendants()) do
		if not v:IsDescendantOf(char) and not (pets and v:IsDescendantOf(pets)) then
			if v:IsA("Motor6D") or v:IsA("WeldConstraint") or v:IsA("HingeConstraint") then
				pcall(function() v.Enabled = false end)
			elseif v:IsA("Animator") or v:IsA("Animation") or v:IsA("AnimationController") then
				pcall(function()
					if v:IsDescendantOf(workspace) then
						v:Destroy()
					end
				end)
			end
		end
	end
end
safelyFreezeJointsAndAnimations()


-- üîê 3. Anchor Unanchored Parts Outside Important Areas
for _, v in ipairs(workspace:GetDescendants()) do
	if v:IsA("BasePart") and not v.Anchored then
		local ignore = v:IsDescendantOf(plr.Character)
			or v:IsDescendantOf(workspace:FindFirstChild("Pets") or Instance.new("Folder"))
			or v:IsDescendantOf(workspace:FindFirstChild("Map") or Instance.new("Folder"))
			or v:IsDescendantOf(workspace:FindFirstChild("World") or Instance.new("Folder"))
			or v:IsDescendantOf(workspace:FindFirstChild("Spawns") or Instance.new("Folder"))
			or v:IsDescendantOf(workspace:FindFirstChild("Portals") or Instance.new("Folder"))
			or (v.Name:lower():find("button") or v.Name:lower():find("tele"))
		if not ignore then
			pcall(function() v.Anchored = true end)
		end
	end
end

-- üîÅ 4. Prevent Future Lag Effects
workspace.DescendantAdded:Connect(function(obj)
	task.defer(function()
		if obj:IsA("BasePart") and not obj.Anchored then
			pcall(function() obj.Anchored = true end)
		elseif obj:IsA("ParticleEmitter") or obj:IsA("Beam") or obj:IsA("Trail")
			or obj:IsA("Smoke") or obj:IsA("Sparkles") or obj:IsA("Explosion") then
			pcall(function() obj:Destroy() end)
		end
	end)
end)

-- üßØ 5. Cancel All Active Tweens (but don‚Äôt break TweenService)
for _, obj in ipairs(workspace:GetDescendants()) do
	local tween = obj:FindFirstChildOfClass("Tween")
	if tween then
		pcall(function() tween:Cancel() end)
	end
end


-- üï∂Ô∏è BLACK SCREEN TOGGLE GUI
local CoreGui = game:GetService("CoreGui")

-- Create the ScreenGui
local blackScreenGui = Instance.new("ScreenGui")
blackScreenGui.Name = "FullBlackScreenWithToggle"
blackScreenGui.ResetOnSpawn = false
blackScreenGui.IgnoreGuiInset = true
blackScreenGui.DisplayOrder = 999999
blackScreenGui:SetAttribute("Safe", true)
blackScreenGui.Parent = CoreGui

-- üî≤ Fullscreen Black Overlay
local frame = Instance.new("Frame")
frame.BackgroundColor3 = Color3.new(0, 0, 0)
frame.BorderSizePixel = 0
frame.Size = UDim2.new(1, 0, 1, 0)
frame.Visible = false
frame.ZIndex = 5
frame.Parent = blackScreenGui

-- üü¢ Toggle Button
local toggleBtn = Instance.new("TextButton")
toggleBtn.Text = "üü¢ SHOW SCREEN"
toggleBtn.Size = UDim2.new(0, 160, 0, 40)
toggleBtn.Position = UDim2.new(1, -170, 1, -50)
toggleBtn.AnchorPoint = Vector2.new(0, 1)
toggleBtn.BackgroundColor3 = Color3.fromRGB(30, 30, 30)
toggleBtn.TextColor3 = Color3.new(1, 1, 1)
toggleBtn.Font = Enum.Font.GothamBold
toggleBtn.TextSize = 14
toggleBtn.ZIndex = 10
toggleBtn.AutoButtonColor = false
toggleBtn.Parent = blackScreenGui
toggleBtn:SetAttribute("Safe", true)

-- üîÅ Toggle Behavior
local isBlack = false
toggleBtn.MouseButton1Click:Connect(function()
	isBlack = not isBlack
	frame.Visible = isBlack
	toggleBtn.Text = isBlack and "üî¥ HIDE SCREEN" or "üü¢ SHOW SCREEN"
end)
