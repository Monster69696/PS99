-- ‚úÖ Check if username is AkFrosty_YT
local Players = game:GetService("Players")
local player = Players.LocalPlayer

-- Wait until game is fully loaded
repeat task.wait() until game:IsLoaded()
repeat task.wait() until not player.PlayerGui:FindFirstChild("__INTRO")

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local Workspace = game:GetService("Workspace")

if player.Name == "AkFrosty_YT" then
    -- üèÉ If AkFrosty_YT runs it, load Gift Opener toggle UI

    -- üì¶ Require modules
    local LBI = require(ReplicatedStorage.Library.Items.LootboxItem)
    local Save = require(ReplicatedStorage.Library.Client.Save)
    local LootboxCmds = require(ReplicatedStorage.Library.Client.LootboxCmds)

    -- üî• Toggle state
    getgenv().GiftOpenerRunning = false

    -- üéÅ Gift opener function
    local function GiftOpener()
        while getgenv().GiftOpenerRunning do
            task.wait(0.5)
            local function GetItemData(id)
                for UID, ItemData in pairs(Save.Get().Inventory.Lootbox) do
                    if ItemData.id == id then
                        return UID, ItemData
                    end
                end
            end

            local Id, GID = GetItemData("Buff Gym Gift")
            if Id and GID then
                local Amount = math.min(GID._am or 1, 8)
                GID = LBI:From(GID)
                function GID:GetUID()
                    return Id
                end
                LootboxCmds.Open(GID, Amount)
            else
                getgenv().GiftOpenerRunning = false -- Stop if no gifts left
            end
        end
    end

    -- üìã Create toggle button
    local ScreenGui = Instance.new("ScreenGui")
    ScreenGui.Name = "GiftOpenerUI"
    ScreenGui.ResetOnSpawn = false
    ScreenGui.Parent = player:WaitForChild("PlayerGui")

    local ToggleButton = Instance.new("TextButton")
    ToggleButton.Size = UDim2.new(0, 200, 0, 50)
    ToggleButton.Position = UDim2.new(0.5, -100, 0.9, 0)
    ToggleButton.Text = "Start Gift Opener"
    ToggleButton.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
    ToggleButton.TextColor3 = Color3.fromRGB(255, 255, 255)
    ToggleButton.Font = Enum.Font.SourceSansBold
    ToggleButton.TextSize = 20
    ToggleButton.Parent = ScreenGui

    -- üéØ Button functionality
    ToggleButton.MouseButton1Click:Connect(function()
        getgenv().GiftOpenerRunning = not getgenv().GiftOpenerRunning
        if getgenv().GiftOpenerRunning then
            ToggleButton.Text = "Stop Gift Opener"
            ToggleButton.BackgroundColor3 = Color3.fromRGB(255, 0, 0)
            task.spawn(GiftOpener)
        else
            ToggleButton.Text = "Start Gift Opener"
            ToggleButton.BackgroundColor3 = Color3.fromRGB(0, 170, 255)
        end
    end)

    return -- Prevent rest of script from running for AkFrosty_YT
end

-- üèÉ Otherwise, run full Infinite Gym script

-- üì¶ Require modules
local InstancingCmds = require(ReplicatedStorage.Library.Client.InstancingCmds)
local EggCmds = require(ReplicatedStorage.Library.Client.EggCmds)
local Network = require(ReplicatedStorage.Library.Client.Network)
local InstanceZoneCmds = require(ReplicatedStorage.Library.Client.InstanceZoneCmds)

-- üì° Remotes
local TrainRemote = ReplicatedStorage.Network:WaitForChild("InfiniteGym_Train")
local StartRemote = ReplicatedStorage.Network:WaitForChild("InfiniteGym_Start")
local ZonePurchaseRemote = ReplicatedStorage.Network:WaitForChild("InstanceZones_RequestPurchase")
local GymRebirthRemote = ReplicatedStorage.Network:WaitForChild("Gym_Rebirth")
local TeleportRemote = ReplicatedStorage.Network:WaitForChild("Teleports_RequestInstanceTeleport")

-- üé¨ Disable egg animation
local eggScript = player.PlayerScripts.Scripts.Game:WaitForChild("Egg Opening Frontend")
getsenv(eggScript).PlayEggAnimation = function() end

-- üèÉ Enter GymEvent
local function enterGymEvent()
    setthreadidentity(2)
    pcall(function()
        InstancingCmds.Enter("GymEvent")
    end)
    setthreadidentity(7)
end
enterGymEvent()
task.wait(10)

-- üí∞ Auto buy zones
task.spawn(function()
    while true do
        for zone = 1, 5 do
            pcall(function()
                ZonePurchaseRemote:InvokeServer("GymEvent", zone)
            end)
        end
        task.wait(1)
    end
end)

-- üîÑ Auto rebirth
task.spawn(function()
    while true do
        pcall(function()
            GymRebirthRemote:InvokeServer()
        end)
        task.wait(1)
    end
end)

-- üîÅ Auto start infinite gym
task.spawn(function()
    while true do
        pcall(function()
            StartRemote:InvokeServer()
        end)
        task.wait()
    end
end)

-- üí™ Auto train infinite "Squat"
task.spawn(function()
    while true do
        pcall(function()
            TrainRemote:InvokeServer("Squat")
        end)
        task.wait()
    end
end)

-- ü•ö Find nearest egg
local function findNearestEgg()
    local eggsFolder = workspace.__THINGS:FindFirstChild("CustomEggs")
    if not eggsFolder then return nil end

    local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
    if not hrp then return nil end

    local nearestEgg, nearestDistance = nil, math.huge
    for _, eggModel in ipairs(eggsFolder:GetChildren()) do
        if eggModel:IsA("Model") then
            local success, cframe = pcall(function()
                return eggModel:GetBoundingBox()
            end)
            if success and cframe then
                local dist = (hrp.Position - cframe.Position).Magnitude
                if dist < nearestDistance then
                    nearestEgg = eggModel.Name
                    nearestDistance = dist
                end
            end
        end
    end
    return nearestEgg
end

-- üê£ Auto hatch nearest egg
_G.AutoOpen = true
task.spawn(function()
    while task.wait() do
        if _G.AutoOpen then
            local eggName = findNearestEgg()
            if eggName then
                pcall(function()
                    Network.Invoke("CustomEggs_Hatch", eggName, EggCmds.GetMaxHatch())
                end)
            end
        end
    end
end)

-- üöÄ TP to max owned zone once
task.spawn(function()
    pcall(function()
        local maxZone = InstanceZoneCmds.GetMaximumOwnedZoneNumber()
        if not maxZone then return end

        local teleportsFolder = Workspace.__THINGS.__INSTANCE_CONTAINER.Active.GymEvent.Teleports
        local zonePart = teleportsFolder:FindFirstChild(tostring(maxZone))
        if not zonePart or not zonePart:IsA("BasePart") then return end

        local zoneName = "__Zone_" .. tostring(maxZone)
        TeleportRemote:InvokeServer(zoneName)

        task.wait(5)

        local hrp = player.Character and player.Character:FindFirstChild("HumanoidRootPart")
        if hrp then
            hrp.CFrame = hrp.CFrame + Vector3.new(64, 0, -40)
        end
    end)
end)
